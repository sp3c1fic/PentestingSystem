
using DnsClient;
using Microsoft.AspNetCore.Mvc;
using PentestingSystem.Core.Contracts;
using PentestingSystem.Core.Models.DNS;
using PentestingSystem.Models.DNS;

namespace PentestingSystem.Controllers;

public class DNSLookupController : Controller 
{   
    private readonly IDnsRecordService _dnsRecordService;

    public DNSLookupController(IDnsRecordService dnsRecordService)
    {
        _dnsRecordService = dnsRecordService;
    }

    public async Task<IActionResult> Index()
    {
        var model = new DNSLookupFormModel
        {
            DnsRecordTypes = await _dnsRecordService.GetDnsRecordTypes()
        };
        
        return View(model);
    }
    
    [HttpPost]
    public async Task<IActionResult> FetchDnsRecords(string domainName, string type, string dnsServer)
    {
        
        // type does not evaluate to anything
        
        var lookupClient = new LookupClient();
        var records = await _dnsRecordService.GetDnsRecords(lookupClient, domainName, type, dnsServer);

        Console.WriteLine(type);
        
        var model = new DnsRecordServiceModel
        {
            DomainName = domainName,
            Records = records
        };

        return PartialView("_DNSLookupResults", model);
    }
}
using Microsoft.AspNetCore.Mvc;
using PentestingSystem.Models.WhoIs;
using System.Net;
using Microsoft.AspNetCore.Authorization;
using PentestingSystem.Core.Contracts;

namespace PentestingSystem.Controllers;

[Authorize]
public class WhoIsController : Controller
{
    private readonly IWhoIsService _whoIsService;

    public WhoIsController(IWhoIsService whoIsService)
    {
        _whoIsService = whoIsService;
    }
    public async Task<IActionResult> GetWhoIs(WhoIsFormModel whoismodel)
    {
        var domainName = whoismodel.Domain;
        var ipArray = await Dns.GetHostAddressesAsync(domainName);
        var ip = ipArray[0].ToString();

        try
        {
            var response = await _whoIsService.GetLookupResponse(domainName);
            ViewBag.WhoIsResult = response; 
        }
        catch (Exception ex)
        {
            ViewBag.WhoIsResult = "Error: " + ex.Message;
        }

        var model = new WhoisViewModel
        {
            IpAddress = ip
        };

        return View(model);
    }

    [HttpGet]

    public IActionResult Index()
    {
        return View();
    }
}
